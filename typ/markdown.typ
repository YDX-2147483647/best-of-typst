#import "@preview/cmarker:0.1.6": render
#import "utils.typ": simplify-number

/// Make cmarker support HTML
#let config = (
  h1-level: 0,
  scope: (
    heading: (level: 0, body) => if level == 0 {
      title(body)
    } else {
      heading(level: level, body)
    },
    image: (path, alt: none) => html.img(
      src: path,
      alt: if alt == none { "" } else { alt },
    ),
    rule: html.hr,
  ),
  html: (
    picture: (attrs, body) => html.picture(..attrs, body),
    source: ("void", attrs => html.elem("source", attrs: attrs)),
  ),
)

/// Preprocess the header and footer markdown files
#let preprocess(md, project_count: 0, category_count: 0, stars_count: 0) = {
  md
    // We have to edit this reference, because the ID generated by the parser is in lowercase.
    .replace("#Contribution", "#contribution")
    // Fix the parsing problem of newlines in `<img>`
    .replace(regex("<img\s+src"), "<img src")
    // Evaluate macros
    .replace(
      "{project_count}",
      simplify-number(project_count),
    )
    .replace("{category_count}", simplify-number(category_count))
    .replace("{stars_count}", simplify-number(stars_count))
}
